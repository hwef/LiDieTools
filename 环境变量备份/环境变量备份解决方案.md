以下是一个完整的解决方案，通过Windows计划任务每3小时自动备份环境变量：

### 1. 创建备份脚本
将以下内容保存为 `C:\EnvVarBackup\BackupEnvVars.bat`:
```batch
@echo off
setlocal enabledelayedexpansion

:: 获取时间戳
set "timestamp=%date:~-4%%date:~3,2%%date:~0,2%_%time:~0,2%%time:~3,2%%time:~6,2%"
set "timestamp=%timestamp: =0%"  // 解决空格问题

:: 创建备份目录
set "backupDir=C:\EnvVarBackup\EnvBackup_%timestamp%"
mkdir "%backupDir%" >nul 2>&1

if not exist "%backupDir%" (
    echo [%time%] 创建备份目录失败，请检查权限 >> "C:\EnvVarBackup\backup_log.txt"
    exit /b 1
)

:: 备份注册表项
reg export "HKEY_CURRENT_USER\Environment" "%backupDir%\UserEnvVars.reg" >nul
reg export "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "%backupDir%\SystemEnvVars.reg" >nul 2>&1

:: 记录日志
echo [%timestamp%] 环境变量备份完成 >> "C:\EnvVarBackup\backup_log.txt"

:: 保留最近5个备份
for /f "skip=5" %%d in ('dir /ad /b /o-d "C:\EnvVarBackup\EnvBackup_*" 2^>nul') do (
    rmdir /s /q "C:\EnvVarBackup\%%d"
)

endlocal
```

### 2. 创建计划任务脚本
将以下内容保存为 `SetupEnvVarBackupTask.bat` 并以**管理员身份运行**:
```batch
@echo off
setlocal

:: 创建备份目录
mkdir "C:\EnvVarBackup" >nul 2>&1

:: 检查是否以管理员身份运行
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo 请右键选择"以管理员身份运行"此脚本
    pause
    exit /b 1
)

:: 创建计划任务
schtasks /create /tn "EnvVarBackup" /tr "C:\EnvVarBackup\BackupEnvVars.bat" /sc hourly /mo 3 /ru SYSTEM /rl HIGHEST /f

if %errorLevel% equ 0 (
    echo 计划任务创建成功！每3小时自动备份环境变量
    echo 备份目录: C:\EnvVarBackup
    echo 日志文件: C:\EnvVarBackup\backup_log.txt
) else (
    echo 计划任务创建失败，错误代码: %errorLevel%
)

timeout /t 5 >nul
endlocal
```

### 计划任务特点:
1. **每3小时运行** (`/sc hourly /mo 3`)
2. 使用**SYSTEM账户** (`/ru SYSTEM`) 避免权限问题
3. 以**最高权限运行** (`/rl HIGHEST`)
4. **自动清理**旧备份（保留最近5个）
5. 每次备份创建**带时间戳的文件夹** (格式: YYYYMMDD_HHMMSS)
6. 包含详细的**日志记录**

### 管理计划任务的方法:
- **查看任务**:
  ```cmd
  schtasks /query /tn EnvVarBackup
  ```

- **手动运行任务**:
  ```cmd
  schtasks /run /tn EnvVarBackup
  ```

- **删除任务**:
  ```cmd
  schtasks /delete /tn EnvVarBackup /f
  ```

### 恢复环境变量:
1. 找到对应时间的备份文件夹
2. 双击运行其中的 `.reg` 文件导入
3. **完全刷新**需要重启系统或使用:
   ```cmd
   taskkill /f /im explorer.exe && start explorer.exe
   ```

> **注意**:
> 1. 首次运行必须使用管理员权限
> 2. 备份目录默认为 `C:\EnvVarBackup`，可按需修改
> 3. 系统环境变量修改后需要重启才能完全生效
> 4. 日志文件会记录每次备份的时间戳和状态